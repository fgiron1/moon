#!/bin/bash

# Define colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running as root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}Please run as root${NC}"
  exit 1
fi

case "$1" in
  on)
    # Start Tor service if not running
    systemctl start tor
    
    # Configure iptables for transparent proxy
    echo -e "${YELLOW}Setting up transparent Tor routing...${NC}"
    
    # Flush existing rules
    iptables -F
    iptables -t nat -F
    
    # Don't route Tor's own traffic through Tor
    iptables -t nat -A OUTPUT -m owner --uid-owner tor -j RETURN
    
    # Don't route local traffic through Tor
    iptables -t nat -A OUTPUT -d 127.0.0.0/8 -j RETURN
    
    # Redirect all other TCP traffic through Tor's TransPort
    iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports 9040
    
    # Drop all traffic that might leak
    iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
    iptables -A OUTPUT -m owner --uid-owner tor -j ACCEPT
    iptables -A OUTPUT -d 127.0.0.0/8 -j ACCEPT
    iptables -A OUTPUT -j DROP
    
    echo -e "${GREEN}Tor transparent routing enabled${NC}"
    echo -e "${YELLOW}All traffic is now routed through Tor${NC}"
    ;;

  off)
    # Flush iptables rules
    echo -e "${YELLOW}Disabling Tor transparent routing...${NC}"
    iptables -F
    iptables -t nat -F
    
    # Allow all traffic
    iptables -P INPUT ACCEPT
    iptables -P FORWARD ACCEPT
    iptables -P OUTPUT ACCEPT
    
    echo -e "${GREEN}Tor transparent routing disabled${NC}"
    echo -e "${YELLOW}Normal routing restored${NC}"
    ;;

  status)
    # Check if Tor is running
    if systemctl is-active tor >/dev/null 2>&1; then
      echo -e "${GREEN}Tor service is running${NC}"
    else
      echo -e "${RED}Tor service is not running${NC}"
    fi
    
    # Check if iptables rules for Tor are in place
    if iptables -t nat -L OUTPUT | grep -q "redir ports"; then
      echo -e "${GREEN}Transparent routing is enabled${NC}"
      echo -e "${YELLOW}Your traffic is being routed through Tor${NC}"
    else
      echo -e "${RED}Transparent routing is not enabled${NC}"
      echo -e "${YELLOW}Your traffic is using normal routing${NC}"
    fi
    
    # Check external IP
    echo -e "${YELLOW}Checking connection...${NC}"
    curl -s https://check.torproject.org/ | grep -q "Congratulations"
    if [ $? -eq 0 ]; then
      echo -e "${GREEN}You are connected through Tor${NC}"
    else
      echo -e "${RED}You are NOT connected through Tor${NC}"
    fi
    ;;

  *)
    echo -e "Usage: tor-control {on|off|status}"
    echo -e "  ${YELLOW}on${NC}     - Enable transparent Tor routing for all traffic"
    echo -e "  ${YELLOW}off${NC}    - Disable Tor routing and restore normal connections"
    echo -e "  ${YELLOW}status${NC} - Check Tor connection status"
    ;;
esac